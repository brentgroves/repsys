# **[Encrypted Mosquitto MQTT broker in Kubernetes](https://moreillon.medium.com/encrypted-mosquitto-mqtt-broker-in-kubernetes-26bb7acd11c7)**

**[Report System Install](./report-system-install.md)**\
**[Current Status](../development/status/weekly/current_status.md)**\
**[Back to Main](../README.md)**

## references

- **[JavaScript Client Library for node.js and browsers](https://github.com/mqttjs/MQTT.js)**
- **[JavaScript Web Browser Client](http://www.steves-internet-guide.com/mqtt-websockets/)**
- **[Eclipse Mosquitto](https://mosquitto.org/)**
- **[Somebody's K8s config files](https://github.com/abalage/mosquitto-mqtt-k8s/blob/main/base/mosquitto.conf)**
- **[MQTT WebSocket JavaScript Client library in Browser](http://www.steves-internet-guide.com/using-javascript-mqtt-client-websockets/)**
- **[Many MQTT tutorials](http://www.steves-internet-guide.com/)**
- **[Another K8s MQTT guide](https://www.enabler.no/en/blog/mosquitto-mqtt-broker-in-kubernetes)**

## What is it

**[Eclipse Mosquitto](https://mosquitto.org/)** is an open-source MQTT broker supporting MQTT(S) and Websocket (WS), popular for applications such as IoT.

An **[official Docker image](https://hub.docker.com/_/eclipse-mosquitto)** is available on Docker Hub, making it possible to deploy to Kubernetes.

Public-facing services require encryption which implies SSL certificates. For HTTP-based applications deployed in Kubernetes, SSL certificates are commonly handled by cert-manager with a certificate issuer such as Let’s Encrypt. This makes it possible to encrypt WS connections but encrypting MQTT is more involved.

This article presents how to deploy an encrypted Mosquitto broker, supporting both MQTTS and WSS connections, to Kubernetes.

## Prerequisites

For the purpose of this article, a public-facing Kubernetes cluster with an ingress controlle and rcert-manager installed is required. For the following, the domain example.com and subdomain mqtt.example.com are used as an example and needs to be replaced accordingly.

## **[Deployment](./mosquitto/deployment.yaml)**

Running a Mosquitto container in Kubernetes can be achieved by creating a Kubernetes deployment. The following manifest creates such deployment with ports 8883 and 9001 exposed:

Here, the pod specification configures three volumes mounts:

- **/etc/mosquitto/:** Directory holding mosquitto.conf, the Mosquitto configuration file, mapped to a ConfigMap
- **/mosquitto/data:** Directory holding the Mosquitto persistent data, mapped to a PVC
- **/mosquitto/certs:** Directory where SSL certificates are stored, mapped to a secret. This secret will be created by cert-manager (see below)

## **[ConfigMap](./mosquitto/configmap.yaml)**

When run as a container, Mosquitto is configured via the /etc/mosquitto/mosquitto.conf file. In Kubernetes, this file can be mounted as a ConfigMap such as the following.

Here, two listeners are configured, matching the exposed ports in the configured in the deployment:

- An MQTT listener on port 8883 used for MQTTS connections
- A Websocket listener on port 9001 used for WSS connections

Moreover, Mosquitto is instructed to fetch SSL certificate and key files from the /mosquitto/certs/ directory. As specified in the deployment, this directory is mapped to a secret which is generated by cert-manager as explained further in the article.

On the other hand, the websocket listener does not require SSL configuration as termination will occur at the Ingress (see below).

An important point to notice is that, for the sake of simplicity, authentication settings have been left out. For a public-facing Mosquitto instance, it is imperative to add authentication to the broker.

## **[PVC](./mosquitto/pvc.yaml)**

As defined mosquitto.conf, data requiring persistence is set to be stored in /mosquitto/data/. According to the deployment, this directory is mapped to a PVC, which can created with the following manifest.

## Services

Mosquitto is exposed to clients via **[Kubernetes services](https://kubernetes.io/docs/concepts/services-networking/service/)**. Here two services are created, one for each listener.

As MQTTS connections are encrypted directly at the Mosquitto container level, port 883 is exposed directly via a NodePort, mapped here to 30883. This will allow MQTTS connections to be established via mqtts://mqtt.example.com:30883. NOTE: Aks deployment will need a load balancer if public IP access is required.

On the other hand, WS connections are encrypted externally, which is handled with an Ingress as described in the following section.

## Ingress

Providing external WSS connections to Mosquitto can be achieved with an ingress such as the following. With cert-manager and a certificate issuer such as Let’s Encrypt, SSL certificates can be automatically obtained at deployment, enabled WSS connections via wss://mqtt.example.com

## **[AKS Ingress](../research/a_l/azure/aks/ingress_controllers.md)**

Microsoft recommends thier application routing addon which works with their DNS Zones and Key vault.  I may use it later but will try to configure the standard **[NGinx Ingress](https://kubernetes.github.io/ingress-nginx/)** first.

**[Install Nginx Ingress](https://kubernetes.github.io/ingress-nginx/deploy/#azure)**
Make separate install document.  Thank you Lord for giving me peace today and everyday that I follow you!
